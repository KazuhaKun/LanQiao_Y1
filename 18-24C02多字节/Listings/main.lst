C51 COMPILER V9.54   MAIN                                                                  03/14/2025 20:35:45 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          // // #include <reg52.h>
   2          #include <STC15F2K60S2.h>
   3          #include "iic.h"
   4          
   5          sbit S4 = P3^3;
   6          
   7          //Delay
   8          void Delay(unsigned int t){
   9   1          while(t--);
  10   1      }
  11          //System Init
  12          void Set_HC573(unsigned char channel,unsigned char dat){
  13   1        P2 = (P2 & 0x1f) | (channel << 5);
  14   1        P0 = dat;
  15   1      }
  16          unsigned char LED_State = 0xff;
  17          //SMG
  18          unsigned char SMGCode[] =
  19          {
  20          0xc0, //0
  21          0xf9, //1
  22          0xa4, //2
  23          0xb0, //3
  24          0x99, //4
  25          0x92, //5
  26          0x82, //6
  27          0xf8, //7
  28          0x80, //8
  29          0x90, //9
  30          0x88, //A
  31          0x83, //b
  32          0xc6, //C
  33          0xa1, //d
  34          0x86, //E
  35          0x8e, //F
  36          0xBF, //-
  37          0xff //None
  38          };
  39          void SMG(unsigned char Location,unsigned char num){
  40   1          Set_HC573(6,(0x01 << Location));
  41   1          Set_HC573(7, SMGCode[num]);
  42   1          Delay(500);
  43   1        Set_HC573(7,0xff);
  44   1      }
  45          void SMGDot(unsigned char Location,unsigned char num){
  46   1          Set_HC573(6,(0x01 << Location));
  47   1          Set_HC573(7, SMGCode[num]-0x80);
  48   1          Delay(500);
  49   1        Set_HC573(7,0xff);
  50   1      }
  51          unsigned char dat[8];
  52          
  53          void Write_24C02_Byte(unsigned char addr, unsigned char dat){
  54   1        I2CStart();   //起始信号
C51 COMPILER V9.54   MAIN                                                                  03/14/2025 20:35:45 PAGE 2   

  55   1        I2CSendByte(0xa0);    //设备&写地址
  56   1        I2CWaitAck();   //等待从机应答
  57   1        I2CSendByte(addr);    //内存地址
  58   1        I2CWaitAck();   //等待从机应答
  59   1        I2CSendByte(dat);   //写入数据
  60   1        I2CWaitAck();   //等待从机应答
  61   1        I2CStop();    //停止信号
  62   1      }
  63          
  64          unsigned char Read_24C02_Byte(unsigned char addr){
  65   1        unsigned char tmp;
  66   1        //伪写操作
  67   1        I2CStart();
  68   1        I2CSendByte(0xa0);
  69   1        I2CWaitAck();
  70   1        I2CSendByte(addr);
  71   1        I2CWaitAck();
  72   1        //读取
  73   1        I2CStart();
  74   1        I2CSendByte(0xa1);
  75   1        I2CWaitAck();
  76   1        tmp = I2CReceiveByte();
  77   1        I2CSendAck(1);
  78   1        I2CStop();
  79   1        return tmp;
  80   1      }
  81          
  82          void Write_24C02_Page(unsigned char addr, unsigned char *dat, unsigned char len){
  83   1        unsigned char i;
  84   1        I2CStart();
  85   1        I2CSendByte(0xa0);
  86   1        I2CWaitAck();
  87   1        I2CSendByte(addr);
  88   1        I2CWaitAck();
  89   1        for(i=0;i<len;i++){
  90   2          I2CSendByte(dat[i]);
  91   2          I2CWaitAck();
  92   2        }
  93   1        I2CStop();
  94   1      }
  95          
  96          void Read_24C02_Page(unsigned char addr, unsigned char *dat, unsigned char len){
  97   1        unsigned char i;
  98   1        I2CStart();
  99   1        I2CSendByte(0xa0);
 100   1        I2CWaitAck();
 101   1        I2CSendByte(addr);
 102   1        I2CWaitAck();
 103   1      
 104   1        I2CStart();
 105   1        I2CSendByte(0xa1);
 106   1        I2CWaitAck();
 107   1        for(i=0;i<len-1;i++){
 108   2          dat[i] = I2CReceiveByte();
 109   2          I2CSendAck(0);
 110   2        }
 111   1        dat[len-1] = I2CReceiveByte();
 112   1        I2CSendAck(1);
 113   1        I2CStop();
 114   1      }
 115          
 116          void DisplayNum();
C51 COMPILER V9.54   MAIN                                                                  03/14/2025 20:35:45 PAGE 3   

 117          
 118          void S4_Function(){
 119   1        dat[0]+=1;
 120   1        dat[1]+=2;
 121   1        dat[2]+=5;
 122   1        if(dat[0]>=100) dat[0]=0;
 123   1        if(dat[1]>=100) dat[1]=0;
 124   1        if(dat[2]>=100) dat[2]=0;
 125   1        Write_24C02_Page(0x01,dat,3);
 126   1        DisplayNum();
 127   1      }
 128          
 129          void S4Scan(){
 130   1        if(S4 == 0){
 131   2          Delay(500);
 132   2          if(S4 == 0){
 133   3            S4_Function();
 134   3            while(S4 == 0) DisplayNum();
 135   3          }
 136   2        }
 137   1      }
 138          
 139          void DisplayNum(){
 140   1        SMG(0,dat[0]/10);
 141   1        SMG(1,dat[0]%10);
 142   1        SMG(2,16);
 143   1        SMG(3,dat[1]/10);
 144   1        SMG(4,dat[1]%10);
 145   1        SMG(5,16);
 146   1        SMG(6,dat[2]/10);
 147   1        SMG(7,dat[2]%10);
 148   1      }
 149          void InitSystem(){
 150   1        Set_HC573(0,0x00);
 151   1        Set_HC573(5,0x00);  //Disable Buzzer
 152   1        Set_HC573(4,0xff);  //Disable LED
 153   1        Set_HC573(6,0xff);
 154   1        Set_HC573(7,0xff);  //Disable SMG
 155   1      }
 156          
 157          void main()
 158          {
 159   1          InitSystem();
 160   1        Read_24C02_Page(0x01,dat,3);
 161   1        Delay(100);
 162   1          while(1)
 163   1          {
 164   2          S4Scan();
 165   2          DisplayNum();
 166   2          }
 167   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    591    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     27      16
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.54   MAIN                                                                  03/14/2025 20:35:45 PAGE 4   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
