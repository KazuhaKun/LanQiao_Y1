C51 COMPILER V9.54   MAIN                                                                  03/11/2025 19:36:41 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          // #include <reg52.h>
   2          #include <STC15F2K60S2.h>
   3          
   4          sbit S5 = P3^2;
   5          sbit S4 = P3^3;
   6          sbit L1 = P0^0;
   7          sbit L2 = P0^1;
   8          sbit L3 = P0^2;
   9          sbit L4 = P0^3;
  10          sbit L7 = P0^6;
  11          sbit L8 = P0^7;
  12          //Delay
  13          void Delay(unsigned int t){
  14   1          while(t--);
  15   1      }
  16          
  17          unsigned char SMGCode[] =
  18          {
  19          0xc0, //0
  20          0xf9, //1
  21          0xa4, //2
  22          0xb0, //3
  23          0x99, //4
  24          0x92, //5
  25          0x82, //6
  26          0xf8, //7
  27          0x80, //8
  28          0x90, //9
  29          0x88, //A
  30          0x83, //b
  31          0xc6, //C
  32          0xa1, //d
  33          0x86, //E
  34          0x8e, //F
  35          0xBF, //-
  36          0xff //None
  37          };
  38          
  39          //System Init
  40          void InitHC138(unsigned char channel){
  41   1          P2 = (P2 & 0x1f) | (channel << 5);
  42   1      }
  43          void OutPutP0(unsigned char channel,unsigned char dat){
  44   1          InitHC138(channel);
  45   1          P0 = dat;
  46   1      }
  47          void Disable_Buzzer(){
  48   1          OutPutP0(5,0x00);
  49   1      }
  50          unsigned char LED_State = 0xff;
  51          void Disable_LED(){
  52   1          OutPutP0(4,0xff);
  53   1      }
  54          void InitSystem(){
C51 COMPILER V9.54   MAIN                                                                  03/11/2025 19:36:41 PAGE 2   

  55   1          Disable_Buzzer();
  56   1          Disable_LED();
  57   1      }
  58          
  59          //LED
  60          void LED_Scan(){
  61   1          unsigned char i=0;
  62   1          InitHC138(4);
  63   1          for(i;i<8;i++){
  64   2              P0 = ~(0x01 << i);
  65   2              Delay(50000);
  66   2          }
  67   1          P0 = 0xff;
  68   1      }
  69          //SMG
  70          void SMG_Scan(){
  71   1          unsigned char i=0;
  72   1          for(i;i<8;i++){
  73   2              OutPutP0(6,(0x01 << i));
  74   2              Delay(50000);
  75   2              OutPutP0(7,0x00);
  76   2              Delay(50000);
  77   2          }
  78   1          P0 = 0xff;
  79   1      }
  80          //LED&SMG Check
  81          void LS_Check(){
  82   1          LED_Scan();
  83   1          SMG_Scan();
  84   1      }
  85          
  86          unsigned char Sec=0;
  87          unsigned char Min=0;
  88          unsigned char Hour=0;
  89          //Timer0
  90          void InitTimer0(){
  91   1          TMOD &= 0xf0;
  92   1          TMOD |= 0x01;
  93   1      
  94   1          //50ms
  95   1          TH0 = (65535-50000)/256;
  96   1          TL0 = (65535-50000)%256;
  97   1      
  98   1          ET0 = 1;
  99   1          EA = 1;
 100   1          TR0 = 1;
 101   1      }
 102          void TimeSet();
 103          void ServiceTimer0() interrupt 1
 104          {
 105   1          static unsigned char Count0;
 106   1          TH0 = (65535-50000)/256;
 107   1          TL0 = (65535-50000)%256;
 108   1          Count0++;
 109   1          if(Count0 >= 40) {Count0 = 0;Sec += 2;}
 110   1          TimeSet();
 111   1      
 112   1      }
 113          //Nixie CountDown
 114          void TimeSet(){
 115   1          if(Sec >= 60){Sec = 0;Min++;}
 116   1          if(Min >= 60){Min = 0;Hour++;}
C51 COMPILER V9.54   MAIN                                                                  03/11/2025 19:36:41 PAGE 3   

 117   1          if(Hour >= 99){Hour = 0;}
 118   1      }
 119          void SMG(unsigned char Location,unsigned char num){
 120   1          OutPutP0(6,(0x01 << Location));
 121   1          // Delay(1000);
 122   1          OutPutP0(7, SMGCode[num]);
 123   1          Delay(1000);
 124   1      }
 125          void SMGDisplay(){
 126   1          SMG(0,Hour/10);
 127   1          SMG(1,Hour%10);
 128   1          SMG(2,16);
 129   1          SMG(3,Min/10);
 130   1          SMG(4,Min%10);
 131   1          SMG(5,16);
 132   1          SMG(6,Sec/10);
 133   1          SMG(7,Sec%10);
 134   1      }
 135          
 136          //Local LED Control
 137          void LocalLEDSet(){
 138   1          if(S5 == 0){
 139   2              Delay(100);
 140   2              while(S5 == 0) SMGDisplay();
 141   2              LED_State ^= 0x40;
 142   2              OutPutP0(4, LED_State);
 143   2          }
 144   1          if(S4 == 0){
 145   2              Delay(100);
 146   2              while(S4 == 0) SMGDisplay();
 147   2              LED_State ^= 0x80;
 148   2              OutPutP0(4, LED_State);
 149   2          }
 150   1      }
 151          
 152          //UART Control
 153          void InitUART(){
 154   1          TMOD &= 0x0f;
 155   1          TMOD |= 0X20; //8位自动重装
 156   1          TH1 = 0xfd;
 157   1          TL1 = 0Xfd;
 158   1          TR1 = 1;
 159   1      
 160   1          SCON = 0x50;
 161   1          AUXR = 0x00;
 162   1      
 163   1          ES = 1;
 164   1          EA = 1;
 165   1      }
 166          unsigned char command = 0x00;
 167          void ServiceUART() interrupt 4
 168          {
 169   1          if(RI == 1){
 170   2              RI = 0;
 171   2              command = SBUF;
 172   2          }
 173   1      }
 174          void SendByte(unsigned char dat){
 175   1          SBUF = dat;
 176   1          while(TI == 0);
 177   1          TI = 0;
 178   1      }
C51 COMPILER V9.54   MAIN                                                                  03/11/2025 19:36:41 PAGE 4   

 179          void UARTWorking(){
 180   1          unsigned char bcd_s,bcd_m,bcd_h;
 181   1          if(command != 0){
 182   2              switch(command & 0xf0){
 183   3                  case 0xa0:
 184   3                  LED_State = (LED_State & 0Xf0) | (~command & 0x0f); //1011 0101 //0000 0101 //1111 1010 //0100
             - 1010 //0000 1010
 185   3                  OutPutP0(4,LED_State);
 186   3                  command = 0x00;
 187   3                  break;
 188   3                  case 0xb0:
 189   3                  bcd_s = ((Sec/10)<<4) + (Sec%10);
 190   3                  bcd_m = ((Min/10)<<4) + (Min%10);
 191   3                  bcd_h = ((Hour/10)<<4) + (Hour%10);
 192   3      
 193   3                  SendByte(bcd_h);
 194   3                  SendByte(bcd_m);
 195   3                  SendByte(bcd_s);
 196   3                  command = 0x00;
 197   3                  break;
 198   3              }
 199   2          }
 200   1      }
 201          
 202          void main()
 203          {
 204   1          InitSystem();
 205   1          Delay(100);
 206   1          LS_Check();
 207   1          InitTimer0();
 208   1          InitUART();
 209   1          while(1)
 210   1          {
 211   2              SMGDisplay();
 212   2              LocalLEDSet();
 213   2              UARTWorking();
 214   2          }
 215   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    630    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
